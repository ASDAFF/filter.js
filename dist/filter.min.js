/*
 * filter.js
 * 2.0.0 (2015-01-01)
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 * Copyright 2011-2015 Jiren Patel[jirenpatel@gmail.com]
 *
 * Dependency:
 *  jQuery(v1.9 >=)
 */
/*
 * JsonQuery
 * version: 0.0.2 (15/8/2014)
 *
 * Licensed under the MIT:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Copyright 2014 Jiren Patel[jirenpatel@gmail.com]
 *
 */
!function(t){"use strict";var e=function(t,e){return new s(t,e||{})};t.JsonQuery=e,e.VERSION="0.0.2",Object.defineProperty||(Object.defineProperty=function(t,e,i){t[e]=i.get});var i=function(t,e,i){if(t.length===+t.length)for(var r=0,s=t.length;s>r;r++)e.call(i,t[r],r);else for(var n in t)hasOwnProperty.call(t,n)&&e.call(i,t[n],n)},r=function(t,e,i){for(var r=0,s=t.length;s>r;r++)if(e.call(i,t[r],r)===!1)return},s=function(t,e){this.records=t||[],this.getterFns=e.getterFns||{},this.lat=e.latitude||"latitude",this.lng=e.longitude||"longitude",this.id=e.id,this.records.length&&a(this,t[0],e.schema)},n=s.prototype,a=function(t,e,i){t.schema={},t.id||(t.id=e._id?"_id":"id"),i||(h.call(t,e),c.call(t,e))},o=function(t){if(null==t)return"String";/*
     * @info Fix for IE 10 & 11
     * @bug Invalid calling object
     */
var e=Object.prototype.toString.call(t).slice(8,-1);return"String"==e&&t.match(/\d{4}-\d{2}-\d{2}/)?"Date":e},h=function(t,e){var i,r,s,n;for(i in t)n=t[i],r=o(n),s=e?e+"."+i:i,this.schema[s]=r,"Object"==r?h.call(this,n,s):"Array"==r&&(["Object","Array"].indexOf(o(n[0]))>-1?h.call(this,t[i][0],s):this.schema[s]=o(n[0]))},c=function(t){var e,i,r;for(e in this.schema){i=this.schema[e];try{this.getterFns[e]||(this.getterFns[e]=l.call(this,e,i)),//Remap if it is array
r=this.getterFns[e](t),"Array"==o(r)&&(this.schema[e]="Array")}catch(s){console.log("Error while generating getter function for selector : "+e+" NOTE: Define manually")}}},u=function(t,e){for(var i,r=0,s=0,n=e.length-1,a=e.length-1;a>=0;a--)i=e.slice(0,a+1).join("."),"Array"==t[i]&&n>a&&(r=a,s+=1);return s>1?r+1:-1},l=function(t){for(var e,i,r,s="",n=t.split("."),a=u(this.schema,n),o=n.length-1;o>=0;o--)e=n.slice(0,o+1).join("."),i="['"+n[o]+"']",s="Array"==this.schema[e]?a==o?i+(s.length?".map(function(r"+o+"){  objs.push(r"+o+s+")})":""):i+(s.length?".map(function(r"+o+"){  return r"+o+s+"})":""):i+s;return r=a>-1?"var objs = []; obj"+s+";"+("Date"==this.schema.path?"return parseDate(objs)":"return objs;"):"return "+("Date"==this.schema.path?"parseDate(obj"+s+");":"obj"+s+";"),new Function("obj",r)};n.operators={eq:function(t,e){return t==e},ne:function(t,e){return t!=e},lt:function(t,e){return e>t},lte:function(t,e){return e>=t},gt:function(t,e){return t>e},gte:function(t,e){return t>=e},"in":function(t,e){return e.indexOf(t)>-1},ni:function(t,e){return-1==e.indexOf(t)},li:function(t,e){return e.test(t)},bt:function(t,e){return t>=e[0]&&t<=e[1]}},n.addOperator=function(t,e){this.operators[t]=e};// rVal = Record Value
// cVal = Condition Value
var f=function(t,e,i){var r=0,s=t.length;for(r;s>r;r++)if(i(t[r],e))return!0};n.addCondition=function(t,e){this.operators[t]=e},n.getCriteria=function(t){var e=t.split(".$");return{field:e[0],operator:e[1]||"eq"}},n.setGetterFn=function(t,e){this.getterFns[t]=e},n.addRecords=function(t){return t&&t.length?("Array"==o(t)?this.records=this.records.concat(t):this.records.push(t),this.schema||a(this,t[0]),!0):!1},n._findAll=function(t,e,r,s){var n,a,o,h=[],c=this.getterFns[e];return"li"==s&&"string"==typeof r&&(r=new RegExp(r)),n=this.operators[s],"Array"==this.schema[e]&&(o=n,n=f),i(t,function(t){a=c(t),n(a,r,o)&&h.push(t)}),h},n.find=function(t,e){var i,s;return e||(e=t,t=this.id),s=this.getterFns[t],r(this.records,function(t){return s(t)==e?(i=t,!1):void 0}),i},i(["where","or","groupBy","select","pluck","limit","offset","order","uniq","near"],function(t){n[t]=function(){var e=new y(this,this.records);return e[t].apply(e,arguments),e}}),i(["count","first","last","all"],function(t){Object.defineProperty(n,t,{get:function(){return new y(this,this.records)[t]}})});var p=function(t,e,i){for(var r=0,s=i.length;s>r;r++)if(this.getterFns[i[r]](t)!==this.getterFns[i[r]](e))return!1;return!0},g=function(t,e){var i,r,s;for(i in t)r=this.jQ.getCriteria(i),s=this.jQ._findAll(s||e,r.field,t[i],r.operator);return s},d=function(t,e){{var r,s=this.jQ.getterFns[t],n={};e.length}return i(e,function(t){r=s(t),(n[r]||(n[r]=[])).push(t)}),n},v=function(t,e){for(var i,r,s=e.slice(0),n=0,a=t.length;a>n;n++)i=this.jQ.getterFns[t[n].field],r="asc"==t[n].direction?1:-1,s.sort(function(t,e){var s=i(t),n=i(e);return(n>s?-1:s>n?1:0)*r});return s},m=function(t,e){var r,s=this,n=[];return i(t,function(t){r=s.jQ.getterFns[t],i(e,function(e,i){(n[i]||(n[i]={}))[t]=r(e)})}),n},_=function(t,e){var r=this.jQ.getterFns[t],s=[];return i(e,function(t){s.push(r(t))}),s},b=function(t,e){var r=[],s=this;return"Object"!=o(e[0])?(i(e,function(t){-1==r.indexOf(t)&&r.push(t)}),r):(r.push(e[0]),i(e,function(e){for(var i=!1,n=0,a=r.length;a>n;n++)p.call(s.jQ,r[n],e,t)&&(i=!0);i||r.push(e)}),r)},y=function(t,e){return this.jQ=t,this.records=e,this.criteria={},this},j=y.prototype;j.each=function(t,e){i(this.exec()||[],t,e)},j.exec=j.toArray=function(t){var e;return this.criteria.all&&(e=this.records),this.criteria.where&&(e=g.call(this,this.criteria.where,e||this.records)),this.criteria.or&&(e=e.concat(g.call(this,this.criteria.or,this.records)),e=b.call(this,[this.jQ.id],e)),this.criteria.order&&(e=v.call(this,this.criteria.order,e||this.records)),this.criteria.near&&(e=x.call(this,this.criteria.near,e||this.records)),this.criteria.uniq&&(e=b.call(this,this.criteria.uniq,e||this.records)),this.criteria.select&&(e=m.call(this,this.criteria.select,e||this.records)),this.criteria.pluck&&(e=_.call(this,this.criteria.pluck,e||this.records)),this.criteria.limit&&(e=(e||this.records).slice(this.criteria.offset||0,(this.criteria.offset||0)+this.criteria.limit)),this.criteria.group_by&&(e=d.call(this,this.criteria.group_by,e||this.records)),t&&i(e||this.records,t),e||(e=this.records),this.jQ.onResult&&this.jQ.onResult(e,this.criteria),e};var w=function(t,e){var i;this.criteria[t]||(this.criteria[t]={});for(i in e)this.criteria[t][i]=e[i];return this};j.where=function(t){return w.call(this,"where",t)},j.or=function(t){return w.call(this,"or",t)},j.groupBy=function(t){return this.criteria.group_by=t,this},j.select=function(){return this.criteria.select=arguments,this},j.pluck=function(t){return this.criteria.pluck=t,this},j.limit=function(t){return this.criteria.limit=t,this},j.offset=function(t){return this.criteria.offset=t,this},j.order=function(t){var e;this.criteria.order=this.criteria.order||[];for(e in t)this.criteria.order.push({field:e,direction:t[e].toLowerCase()});return this},j.uniq=function(){return this.criteria.uniq=arguments.length>0?arguments:!0,this},Object.defineProperty(j,"count",{get:function(){this.criteria.count=!0;var t=this.exec();return"Array"==o(t)?this.exec().length:Object.keys(t).length}}),Object.defineProperty(j,"all",{get:function(){return this.criteria.all=!0,this.exec()}}),Object.defineProperty(j,"first",{get:function(){return this.criteria.first=!0,this.exec()[0]}}),Object.defineProperty(j,"last",{get:function(){this.criteria.last=!0;var t=this.exec();return t[t.length-1]}});//Geocoding
var P={redius:6371,toRad:function(t){return t*Math.PI/180}},F=function(t,e,i,r){var s=P.toRad(e-t),n=P.toRad(r-i),t=P.toRad(t),e=P.toRad(e),a=Math.sin(s/2)*Math.sin(s/2)+Math.sin(n/2)*Math.sin(n/2)*Math.cos(t)*Math.cos(e);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*P.redius},x=function(t,e){var r=[],s=this,n="mile"==t.unit?.6214:1,a=s.jQ.getterFns[s.jQ.lat],o=s.jQ.getterFns[s.jQ.lng];return i(e,function(e){e._distance=F(a(e),t.lat,o(e),t.lng)*n,e._distance<=t.distance&&r.push(e)}),r.sort(function(t,e){return t._distance<e._distance?-1:t._distance>e._distance?1:0}),r};j.near=function(t,e,i,r){return this.criteria.near={lat:t,lng:e,distance:i,unit:r||"km"},this},//Helpers
j.map=j.collect=function(t){var e,i=[];return this.exec(function(r){(e=t(r))&&i.push(e)}),i},j.sum=function(t){var e,r=0,s=this.jQ.getterFns[t];return this.criteria.group_by&&(e=!0,r={}),this.exec(function(t,n){e?(r[n]=0,i(t,function(t){r[n]=r[n]+(s(t)||0)})):r+=s(t)||0}),r},j.toJQ=function(){var t=e(this.all,{schema:!0});return t.schema=this.jQ.schema,t.getterFns=this.jQ.getterFns,t}}(this),//In IE indexOf method not define.
Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){for(var i=e||0,r=this.length;r>i;i++)if(this[i]===t)return i;return-1}),function(t,e){"use strict";function i(t,e){var i=a,r="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(i.escape,function(t,e){return"',escapeStr("+e.replace(/\\'/g,"'")+"),'"}).replace(i.interpolate,function(t,e){return"',"+e.replace(/\\'/g,"'")+",'"}).replace(i.evaluate||null,function(t,e){return"');"+e.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",s=new Function("obj",r);return e?s(e):function(t){return s(t)}}function r(e,i){this.opts=t.extend({inner_window:0,outer_window:0,left:0,right:0},e),this.opts.window=this.opts.window||this.opts.inner_window||3,this.opts.left=this.opts.left||this.opts.outer_window,this.opts.right=this.opts.right||this.opts.outer_window,this.opts.per_page=this.opts.per_page||{},this.opts.per_page.values=[].concat(this.opts.per_page.values||[20,30,50]),this.perPage=this.opts.per_page.values[0],this.currentPage=1,this.lastCurrentPage=null,this.initTemplates(),this.$container=t(this.opts.container),this.bindEvents(i)}function s(t,e,i){var r=parseInt(t);return r?r:"first"==t?1:"last"==t?e:"next"==t?i==e?i:i+1:"previous"==t?1==i?1:i-1:t}function n(t,e,i,r){this.opts=t,this.last=i,this.current=r,this.num=s(e)}//View Template
// Ref: Underscopre.js
//JavaScript micro-templating, similar to John Resig's implementation.
var a={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},o=function(t,e,i){var r=new h(t,e,i);return o.list.push(r),r};o.VERSION="2.0.0",o.list=[],e.FilterJS=o;var h=function(e,r,s){var n=this;this.opts=s||{},this.callbacks=this.opts.callbacks||{},this.$container=t(r),this.view=this.opts.view||u,this.templateFn=i(t.trim(t(this.opts.template).html())),this.criterias=[],this._index=1,t.each(this.opts.criterias||[],function(){n.addCriteria(this)}),this.Model=JsonQuery(),this.Model.getterFns._fid=function(t){return t._fid},this.opts.pagination&&this.initPaginator(this.opts.pagination),this.addRecords(e)},c=h.prototype;Object.defineProperty(c,"records",{get:function(){return this.Model.records}}),Object.defineProperty(c,"recordsCount",{get:function(){return this.Model.records.length}}),//Callback
c.execCallback=function(t,e){this.callbacks[t]&&this.callbacks[t].call(this,e)},c.addCallback=function(t,e){t&&e&&(this.callbacks[t]=e)},//Add Data
c.addRecords=function(t){t&&t.length&&(this.execCallback("beforeAddRecords",t),this.Model.addRecords(t)&&(this.Model.schema||this.initSearch(this.opts.search),this.render(t),this.filter()),this.execCallback("afterAddRecords",t))},c.removeRecords=function(e){var i;if(t.isPlainObject(e)?i=this.Model.where(e).pluck("_fid").all:t.isArray(e)&&(i=this.Model.where({"id.$in":e}).pluck("_fid").all),!i)return!1;for(var r,s=this.Model.records,n=0,a=i.length,o=s.length-1;o>-1&&(r=s[o]._fid,i.indexOf(r)>-1&&(s.splice(o,1),n++,t("#fjs_"+r).remove()),n!=a);o--);return this.execCallback("afterRemove"),!0};var u=function(t){return this.templateFn(t)};c.render=function(e){var i,r="beforeRecordRender",s="id",n="fjs_item",a=this;this.execCallback("beforeRender",e),e.forEach(function(e,o){a.execCallback(r,e),e._fid=a._index++,i=t(a.view(e,o)),i.attr(s,"fjs_"+e._fid),i.addClass(n),a.$container.append(i)})};var l=function(t){var e=t.$ele,i=t.$ele.attr("type");return t.selector||("INPUT"==e.get(0).tagName?t.selector="checkbox"==i||"radio"==i?":checked":":input":"SELECT"==e.get(0).tagName&&(t.selector="select")),t.event||(t.event="checkbox"==i||"radio"==i?"click":"change"),t},f=function(e,i){t("body").on(e.event,e.ele,function(){i.filter()})};c.addCriteria=function(e){var i=this;return e?(t.isArray(e)?t.each(e,function(){p.call(i,this)}):p.call(i,e),!0):!1};// Add Filter criteria
// criteria: { ele: '#name', event: 'check', field: 'name', type: 'range' }
var p=function(e){return e&&e.field&&e.ele?(e.$ele=t(e.ele),e.$ele.length?(e=l(e),f(e,this),e._q=e.field+("range"==e.type?".$bt":""),e.active=!0,this.criterias.push(e),!0):!1):!1};c.removeCriteria=function(e){var i,r,s=this;t.each(s.criterias,function(t){this.field==e&&(r=t)}),r&&(i=this.criterias.splice(r,1)[0],t("body").off(i.event,i.ele))};var g=function(e,i){var r=this;e&&(t.isArray(e)||(e=[e]),t.each(e,function(){var e=this;t.each(r.criterias,function(){this.field==e&&(this.active=i)})}))};c.deactivateCriteria=function(t){g.call(self,t,!1)},c.activateCriteria=function(t){g.call(this,t,!0)};var d=function(e){var i=[];return e.$ele.filter(e.selector).each(function(){i.push(t(this).val())}),"range"==e.type&&(i=i[0].split("-")),i};c.lastResult=function(){return this.last_result||this.records},c.filter=function(){var e,i,r={};return t.each(this.criterias,function(){this.active&&(e=d(this),(e||e.length)&&(i=t.isArray(e)&&!this.type?this._q+".$in":this._q,r[i]=e))}),this.last_result=this.Model.where(r).all,this.searchFilter(this.last_result)?r:(this.show(this.last_result),this.execCallback("afterFilter",this.last_result),r)},//HideShow element
c.show=function(e){var i=this.renderPagination(e.length);t(".fjs_item").hide();for(var r=i.start;r<i.end;r++)t("#fjs_"+e[r]._fid).show()};//Search
var v=function(e,i,r){t("body").on("keyup",e,function(){r.searchTimeoutId&&clearTimeout(r.searchTimeoutId),r.searchTimeoutId=setTimeout(function(){r.filter()},i)})};c.initSearch=function(e){(e||e.ele)&&(e.start_length||(this.opts.search.start_length=2),this.$search_ele=t(this.opts.search.ele),this.$search_ele.length&&(this.has_search=!0,this.searchFn=this.buildSearchFn(e.fields),v(e.ele,e.timeout||0,this)))},c.buildSearchFn=function(e){var i=this,r=[];return e?t.each(e,function(){r.push(i.Model.getterFns[this])}):t.each(i.Model.getterFns,function(t,e){r.push(e)}),function(t,e){t=t.toLocaleUpperCase();for(var i=0,s=r.length;s>i;i++)if((r[i](e)+"").toLocaleUpperCase().indexOf(t)>-1)return!0;return!1}},c.searchFilter=function(e){if(this.has_search){var i,r=t.trim(this.$search_ele.val());return r.length<this.opts.search.start_length?!1:(i=this.search(r,e||this.lastResult()),this.show(i),this.execCallback("afterFilter",i),!0)}},c.search=function(t,e){t=t.toLocaleUpperCase();for(var i=[],r=0,s=e.length;s>r;r++)this.searchFn(t,e[r])&&i.push(e[r]);return i},//Streaming
c.setStreaming=function(t){t&&(this.opts.streaming=t,t.data_url&&(t.stream_after=1e3*(t.stream_after||2),t.batch_size=t.batch_size||!1,this.streamData(t.stream_after)))};var m=function(){var e=this,i=this.opts.params||{},r=this.opts.streaming;i.offset=this.recordsCount,r.batch_size&&(i.limit=r.batch_size),this.has_search&&(i.q=t.trim(this.$search_ele.val())),t.getJSON(r.data_url,i).done(function(t){null==i.limit||t&&t.length?(e.setStreamInterval(),e.addRecords(t)):e.stopStreaming()}).fail(function(){e.stopStreaming()})};c.setStreamInterval=function(){var t=this;1!=t.opts.streaming.stop&&(t.streamingTimer=setTimeout(function(){m.call(t)},t.opts.streaming.stream_after))},c.stopStreaming=function(){this.opts.streaming.stop=!0,this.streamingTimer&&clearTimeout(this.streamingTimer)},c.resumeStreaming=function(){this.opts.streaming.stop=!1,this.streamData(this.opts.streaming.stream_after)},c.streamData=function(){this.setStreamInterval(),this.opts.streaming.batch_size||this.stopStreaming()},c.initPaginator=function(){var t=this;this.paginator=new r(this.opts.pagination,function(e){t.show(t.lastResult(),e)})},c.renderPagination=function(t){return this.paginator?this.paginator.render(t):{start:0,end:t}};var _=r.prototype;_.initTemplates=function(){var e,r;e=this.opts.template?t(this.opts.template).html():'<nav>  <ul class="pagination">    <% if(!current_page.isFirst()) { %>      <li> <a href="#" data-page="first" aria-label="First"><span aria-hidden="true">First</span></a> </li>      <li><a href="#" data-page="previous" aria-label="Previous"><span aria-hidden="true">&larr; Previous</span></a></li>    <% } %>    <% for(var i = 0, l = pages.length; i < l; i++ ){ %>        <% if(pages[i].isLeftOuter() || pages[i].isRightOuter() || pages[i].isInsideWindow()) { %>          <li class="<%= pages[i].isCurrent() ? \'active\' : \'\' %>">            <a href="#" data-page="<%= pages[i].num %>"><%= pages[i].num %></a>          </li>        <% }else{ %>          <li class="disabled"><a href="#">...</a></li>        <% } %>    <% } %>    <% if(!current_page.isLast()) { %>      <li><a href="#" data-page="next" aria-label="Next"><span aria-hidden="true">Next &rarr;</span></a></li>      <li><a href="#" data-page="last" aria-label="Last"><span aria-hidden="true">Last</span></a></li>    <% } %>  </ul></nav>',this.paginationTmpl=i(e),this.opts.per_page.container&&(r=this.opts.per_page.template?t(this.opts.perPage.template).html():'<select size="1" name="per_page" data-per-page="true">  <% for(var i = 0; i < options.length; i++ ){ %>    <option value="<%= options[i] %>"><%= options[i] %></option>  <% } %></select>',t(this.opts.per_page.container).html(i(r,{options:this.opts.per_page.values})))},_.rangeToArray=function(t,e){var i=[];for(0>=t?t=1:0>=e&&(e=1),e>this.totalPages&&(e=this.totalPages),t;e>=t;t++)i.push(t);return i},_.getPages=function(){var e,i=0,r=[],s=this.rangeToArray(1,this.opts.left),a=this.rangeToArray(this.currentPage-this.opts.window,this.currentPage+this.opts.window),o=this.rangeToArray(this.totalPages-this.opts.right,this.totalPages),h=t.unique(s.concat(a,o)).sort(function(t,e){return t-e});for(i=0,e=h.length;e>i;i++)this.lastPage=new n(this.opts,h[i],this.totalPages,this.currentPage),r.push(this.lastPage);return r},_.render=function(t){var e;return this.totalItems=t,this.totalPages=Math.ceil(t/this.perPage),e=this.paginationTmpl({pages:this.getPages(),current_page:new n(this.opts,this.currentPage,this.totalPages,this.currentPage)}),this.$container.html(e),this.getOffset(t)},_.bindEvents=function(e){var i=this;if(this.$container.on("click","[data-page]",function(r){r.preventDefault();var n=s(t(this).data("page"),i.totalPages,i.currentPage);n!=i.currentPage&&(i.lastCurrentPage=i.currentPage,i.currentPage=n,e(i.getOffset()))}),this.opts.per_page.container){var r=t(this.opts.per_page.container),n=r.find("[data-per-page]").is("select")?"change":"click";r.on(n,"[data-per-page]",function(r){var s,n=t(this);n.is("a")?(r.preventDefault(),s=n.data("value")||n.text()):s=n.val(),s=parseInt(s),s&&i.perPage!=s&&(i.perPage=s,e(i.getOffset()))})}},_.getOffset=function(t){var e=this.perPage*(this.currentPage-1),i=e+this.perPage;return t||(t=this.totalItems),i>t&&(i=t),{start:e,end:i}};var b=n.prototype;b.isCurrent=function(){return this.num==this.current},b.isFirst=function(){return 1==this.num},b.isLast=function(){return this.num==this.last},b.isPrev=function(){return this.num==this.current-1},b.isNext=function(){return this.num==this.current+1},//within the left outer window or not
b.isLeftOuter=function(){return this.num<=this.opts.left},//within the right outer window or not
b.isRightOuter=function(){return this.last-this.num<this.opts.right},//inside the inner window or not
b.isInsideWindow=function(){return Math.abs(this.current-this.num)<=this.opts.window},b.isTruncated=function(){return"gap"==this.num},t.fn.filterjs=function(e,i){var r=t(this);r.data("fjs")||r.data("fjs",o(e,r,i))}}(jQuery,window,document);